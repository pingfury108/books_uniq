<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books Uniq - 图书数据去重系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #fff;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e3f2fd;
        }
        .progress-section {
            display: none;
        }
        .results-section {
            display: none;
        }
        .book-card {
            transition: all 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .duplicate-group {
            border-left: 4px solid #dc3545;
            background-color: #fff5f5;
        }
        .unique-book {
            border-left: 4px solid #198754;
            background-color: #f0fff4;
        }
        .similarity-score {
            font-weight: bold;
            color: #dc3545;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary"><i class="fas fa-book-open"></i> Books Uniq</h1>
            <p class="lead">智能图书数据去重系统</p>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="mb-5">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-upload"></i> 上传Excel文件</h4>
                </div>
                <div class="card-body">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>拖拽Excel文件到这里或点击上传</h5>
                        <p class="text-muted">支持 .xlsx, .xls 格式</p>
                        <input type="file" id="file-input" class="d-none" accept=".xlsx,.xls">
                        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-folder-open"></i> 选择文件
                        </button>
                    </div>
                    
                    <div id="file-info" class="mt-3" style="display: none;">
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                <strong>已选择：</strong> <span id="file-name"></span>
                                <small class="text-muted ms-2" id="file-size"></small>
                            </div>
                            <div>
                                <button class="btn btn-success btn-sm me-2" id="process-btn" onclick="processFile()">
                                    <i class="fas fa-play"></i> 开始处理
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetUpload()">
                                    <i class="fas fa-times"></i> 取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="progress-section mb-5">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4><i class="fas fa-cog fa-spin"></i> 处理进度</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>向量化进度</label>
                                <div class="progress">
                                    <div id="embedding-progress" class="progress-bar bg-info" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="embedding-status">等待开始...</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>去重进度</label>
                                <div class="progress">
                                    <div id="dedup-progress" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="dedup-status">等待开始...</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-container" id="log-container">
                        <div class="text-muted">处理日志将在这里显示...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-book-open fa-2x mb-2"></i>
                            <h5>总书籍数</h5>
                            <h3 id="total-books">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h5>唯一书籍</h5>
                            <h3 id="unique-books">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-copy fa-2x mb-2"></i>
                            <h5>重复书籍</h5>
                            <h3 id="duplicate-books">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white text-center">
                        <div class="card-body">
                            <i class="fas fa-percentage fa-2x mb-2"></i>
                            <h5>去重率</h5>
                            <h3 id="dedup-rate">0%</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-list"></i> 去重结果</h4>
                    <div>
                        <button class="btn btn-light btn-sm me-2" onclick="downloadResults()">
                            <i class="fas fa-download"></i> 导出结果
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="resetAll()">
                            <i class="fas fa-redo"></i> 重新上传
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary active" onclick="showTab('all')">
                                全部 (<span id="all-count">0</span>)
                            </button>
                            <button class="btn btn-outline-success" onclick="showTab('unique')">
                                唯一 (<span id="unique-count">0</span>)
                            </button>
                            <button class="btn btn-outline-danger" onclick="showTab('duplicates')">
                                重复 (<span id="duplicate-count">0</span>)
                            </button>
                        </div>
                    </div>
                    
                    <div id="results-container">
                        <!-- 结果将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 错误详情模态框 -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> 错误详情
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="error-details">
                        <!-- 错误详情将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="copyErrorToClipboard()">
                        <i class="fas fa-copy"></i> 复制错误信息
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFile = null;
        let processResults = [];
        let currentTab = 'all';

        // 文件上传处理
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('请选择Excel文件 (.xlsx 或 .xls)');
                return;
            }
            
            currentFile = file;
            fileName.textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // 折叠上传区域
            uploadArea.style.display = 'none';
        }

        // 处理文件
        async function processFile() {
            if (!currentFile) return;

            // 显示进度区域
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('process-btn').disabled = true;
            
            // 重置进度
            updateProgress('embedding', 0, '准备上传文件...');
            updateProgress('dedup', 0, '等待向量化完成...');
            addLog('开始处理文件: ' + currentFile.name);

            try {
                // 1. 上传并解析Excel文件
                const formData = new FormData();
                formData.append('file', currentFile);
                
                addLog('正在上传和解析Excel文件...');
                const uploadResponse = await fetch('/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('文件上传失败');
                }
                
                const uploadData = await uploadResponse.json();
                addLog(`文件解析完成，共发现 ${uploadData.total_records} 条记录`);
                
                // 2. 批量向量化
                await performEmbedding(uploadData.records);
                
                // 3. 相似性搜索和去重
                await performDeduplication(uploadData.records);
                
            } catch (error) {
                addLog(`处理失败: ${error.message}`, 'error');
                alert('处理失败: ' + error.message);
            } finally {
                document.getElementById('process-btn').disabled = false;
                // 处理完成后完全隐藏上传区域
                document.getElementById('upload-section').style.display = 'none';
            }
        }

        // 向量化处理
        async function performEmbedding(records) {
            updateProgress('embedding', 0, '正在启动处理任务...');
            addLog(`开始处理 ${records.length} 条记录...`);
            
            const batchSize = 50;
            const totalBatches = Math.ceil(records.length / batchSize);
            
            addLog(`将分 ${totalBatches} 批次处理，每批 ${batchSize} 条记录`, 'info');
            
            try {
                // 1. 启动异步任务
                const startResponse = await fetch('/start-processing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        records: records,
                        collection_name: 'books',
                        batch_size: batchSize
                    })
                });
                
                if (!startResponse.ok) {
                    const errorMessage = await handleApiError(startResponse, '启动处理任务');
                    throw new Error(errorMessage);
                }
                
                const startData = await startResponse.json();
                const taskId = startData.task_id;
                
                addLog(`任务已启动 (ID: ${taskId.slice(-8)})，开始监控进度...`, 'success');
                
                // 2. 轮询监控进度
                let result = null;
                const pollInterval = 2000; // 2秒轮询一次
                let lastLoggedBatch = 0;
                
                const pollProgress = async () => {
                    try {
                        const statusResponse = await fetch('/processing-status');
                        if (statusResponse.ok) {
                            const status = await statusResponse.json();
                            
                            if (status.error) {
                                throw new Error(status.error);
                            }
                            
                            if (status.is_processing) {
                                // 更新进度条
                                const progress = status.total_batches > 0 
                                    ? (status.current_batch / status.total_batches) * 100 
                                    : 0;
                                updateProgress('embedding', progress, status.current_operation);
                                
                                // 避免重复日志，只在批次变化时记录
                                if (status.current_batch > lastLoggedBatch) {
                                    const eta = status.estimated_remaining_seconds 
                                        ? `，预计剩余 ${Math.ceil(status.estimated_remaining_seconds / 60)} 分钟`
                                        : '';
                                    addLog(`批次进度: ${status.current_batch}/${status.total_batches} (${progress.toFixed(1)}%)${eta}`, 'info');
                                    lastLoggedBatch = status.current_batch;
                                }
                            }
                            
                            if (status.completed) {
                                if (status.final_result) {
                                    result = status.final_result;
                                    return true; // 完成
                                } else if (status.error) {
                                    throw new Error(status.error);
                                }
                            }
                        }
                        return false; // 继续轮询
                    } catch (e) {
                        console.error('进度轮询失败:', e);
                        return false;
                    }
                };
                
                // 开始轮询
                while (true) {
                    const completed = await pollProgress();
                    if (completed) break;
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                }
                
                if (!result) {
                    throw new Error('处理完成但未获取到结果');
                }
                
                updateProgress('embedding', 100, '向量化完成');
                addLog(`向量化完成: 添加 ${result.added_count} 条，跳过重复 ${result.skipped_count} 条`, 'success');
                
                if (result.skipped_count > 0) {
                    addLog(`跳过 ${result.skipped_count} 条重复记录（基于MD5去重）`, 'warning');
                }
                
                // 显示流式处理统计
                if (result.processing_info && result.processing_info.streaming_mode) {
                    addLog(`流式处理完成: ${result.processing_info.total_batches} 批次，每批 ${result.processing_info.batch_size} 条`, 'info');
                }
                
                return result;
                
            } catch (error) {
                addLog(`向量化处理失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 去重处理
        async function performDeduplication(records) {
            updateProgress('dedup', 0, '开始相似性检测...');
            addLog('开始相似性检测和去重处理...');
            
            // 预估去重时间（基于记录数量）
            const estimatedSeconds = Math.max(10, records.length * 0.1); // 每条记录约0.1秒
            addLog(`预计去重耗时约 ${Math.ceil(estimatedSeconds / 60)} 分钟`, 'info');
            
            try {
                const startTime = Date.now();
                
                const response = await fetch('/find-duplicates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        records: records,
                        collection_name: 'books',
                        similarity_threshold: 0.85
                    })
                });
                
                if (!response.ok) {
                    const errorMessage = await handleApiError(response, '去重处理');
                    throw new Error(errorMessage);
                }
                
                const duplicateData = await response.json();
                const actualMinutes = (Date.now() - startTime) / 60000;
                
                // 整理结果数据
                const results = [];
                const processedIndices = new Set();
                
                // 处理重复组
                duplicateData.duplicate_groups.forEach(group => {
                    results.push({
                        ...group.original,
                        type: 'duplicate',
                        duplicates: group.duplicates.map(dup => ({
                            ...dup.record,
                            similarity: dup.similarity
                        }))
                    });
                    
                    processedIndices.add(group.original_index);
                    group.duplicates.forEach(dup => {
                        processedIndices.add(dup.original_index);
                    });
                });
                
                // 处理唯一记录
                records.forEach((record, index) => {
                    if (!processedIndices.has(index)) {
                        results.push({
                            ...record,
                            type: 'unique'
                        });
                    }
                });
                
                processResults = results;
                
                updateProgress('dedup', 100, '去重完成');
                addLog(`去重处理完成: 发现 ${duplicateData.total_groups} 个重复组，处理了 ${duplicateData.processed_records} 条记录`, 'success');
                addLog(`实际耗时 ${actualMinutes.toFixed(1)} 分钟`, 'info');
                
                // 显示性能统计
                if (duplicateData.performance_stats) {
                    const stats = duplicateData.performance_stats;
                    addLog(`向量复用统计: 复用 ${stats.reused_embeddings} 个，新生成 ${stats.new_embeddings} 个 (效率: ${stats.efficiency_ratio})`, 'success');
                }
                
                // 显示结果
                displayResults();
                
            } catch (error) {
                addLog(`去重处理失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 显示结果
        function displayResults() {
            const uniqueBooks = processResults.filter(r => r.type === 'unique').length;
            const duplicateBooks = processResults.filter(r => r.type === 'duplicate').length;
            const totalBooks = processResults.length;
            const dedupRate = totalBooks > 0 ? Math.round(((totalBooks - duplicateBooks) / totalBooks) * 100) : 0;
            
            // 更新统计数据
            document.getElementById('total-books').textContent = totalBooks;
            document.getElementById('unique-books').textContent = uniqueBooks;
            document.getElementById('duplicate-books').textContent = duplicateBooks;
            document.getElementById('dedup-rate').textContent = dedupRate + '%';
            
            document.getElementById('all-count').textContent = totalBooks;
            document.getElementById('unique-count').textContent = uniqueBooks;
            document.getElementById('duplicate-count').textContent = duplicateBooks;
            
            // 显示结果区域
            document.getElementById('results-section').style.display = 'block';
            
            // 渲染结果列表
            renderResultsList();
        }

        // 渲染结果列表
        function renderResultsList() {
            const container = document.getElementById('results-container');
            let filteredResults = processResults;
            
            if (currentTab === 'unique') {
                filteredResults = processResults.filter(r => r.type === 'unique');
            } else if (currentTab === 'duplicates') {
                filteredResults = processResults.filter(r => r.type === 'duplicate');
            }
            
            let html = '';
            
            filteredResults.forEach((result, index) => {
                const cardClass = result.type === 'unique' ? 'unique-book' : 'duplicate-group';
                
                html += `
                    <div class="card book-card ${cardClass} mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">${result.title || '未知书名'}</h5>
                                    <p class="card-text">
                                        <strong>作者:</strong> ${result.author || '未知作者'}<br>
                                        <strong>出版社:</strong> ${result.publisher || '未知出版社'}<br>
                                        ${result.formatted_text ? `<small class="text-muted">格式化: ${result.formatted_text}</small><br>` : ''}
                                        ${result.md5 ? `<small class="text-muted">MD5: ${result.md5.substring(0, 8)}...</small>` : ''}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${result.type === 'unique' ? 'bg-success' : 'bg-danger'} mb-2">
                                        ${result.type === 'unique' ? '唯一' : '重复'}
                                    </span>
                                    ${result.duplicates ? `<div class="text-muted"><small>发现 ${result.duplicates.length} 个相似项</small></div>` : ''}
                                </div>
                            </div>
                            
                            ${result.duplicates ? `
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#duplicates-${index}">
                                        查看重复项 (${result.duplicates.length})
                                    </button>
                                    <div class="collapse mt-2" id="duplicates-${index}">
                                        ${result.duplicates
                                            .sort((a, b) => b.similarity - a.similarity) // 按相似度从高到低排序
                                            .map(dup => `
                                            <div class="border-start border-danger ps-3 ms-2 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>${dup.title || '未知书名'}</strong><br>
                                                        <small class="text-muted">${dup.author || '未知作者'} - ${dup.publisher || '未知出版社'}</small>
                                                        ${dup.md5 ? `<br><small class="text-muted">MD5: ${dup.md5.substring(0, 8)}...</small>` : ''}
                                                    </div>
                                                    <div class="similarity-score">${(dup.similarity * 100).toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="text-center text-muted py-4">暂无数据</div>';
            }
            
            container.innerHTML = html;
        }

        // 切换标签
        function showTab(tab) {
            currentTab = tab;
            
            // 更新按钮状态
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderResultsList();
        }

        // 更新进度
        function updateProgress(type, percentage, status) {
            document.getElementById(`${type}-progress`).style.width = `${percentage}%`;
            document.getElementById(`${type}-status`).textContent = status;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'text-info';
            let icon = 'fas fa-info-circle';
            
            switch(type) {
                case 'error':
                    colorClass = 'text-danger';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'warning':
                    colorClass = 'text-warning';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'success':
                    colorClass = 'text-success';
                    icon = 'fas fa-check-circle';
                    break;
            }
            
            const logEntry = `
                <div class="${colorClass} mb-1">
                    <i class="${icon}"></i> [${timestamp}] ${message}
                </div>
            `;
            logContainer.innerHTML += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 处理API错误响应
        async function handleApiError(response, operation) {
            let errorMessage = `${operation}失败`;
            
            try {
                const errorData = await response.json();
                
                if (errorData.detail) {
                    errorMessage = errorData.detail;
                }
                
                // 如果有错误ID，添加到日志中
                if (errorData.error_id) {
                    addLog(`错误ID: ${errorData.error_id}`, 'error');
                }
                
                // 如果有错误类型，添加到日志中
                if (errorData.error_type) {
                    addLog(`错误类型: ${errorData.error_type}`, 'error');
                }
                
                // 显示完整错误信息
                if (errorData.error_message && errorData.error_message !== errorData.detail) {
                    addLog(`详细信息: ${errorData.error_message}`, 'error');
                }
                
            } catch (e) {
                // 如果无法解析JSON，使用默认错误信息
                errorMessage = `${operation}失败: HTTP ${response.status} ${response.statusText}`;
            }
            
            return errorMessage;
        }

        // 显示详细错误模态框
        function showErrorDetails(error, operation) {
            const errorDetails = document.getElementById('error-details');
            
            let detailsHtml = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-bug"></i> 操作失败: ${operation}</h6>
                    <p><strong>错误信息:</strong> ${error.message || error}</p>
                </div>
            `;
            
            // 如果有额外的错误信息
            if (error.error_id) {
                detailsHtml += `
                    <div class="mb-3">
                        <label class="form-label"><strong>错误追踪ID:</strong></label>
                        <input type="text" class="form-control" value="${error.error_id}" readonly>
                    </div>
                `;
            }
            
            if (error.error_type) {
                detailsHtml += `
                    <div class="mb-3">
                        <label class="form-label"><strong>错误类型:</strong></label>
                        <input type="text" class="form-control" value="${error.error_type}" readonly>
                    </div>
                `;
            }
            
            if (error.stack) {
                detailsHtml += `
                    <div class="mb-3">
                        <label class="form-label"><strong>堆栈追踪:</strong></label>
                        <textarea class="form-control" rows="8" readonly>${error.stack}</textarea>
                    </div>
                `;
            }
            
            detailsHtml += `
                <div class="text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        如果问题持续存在，请将错误ID和详细信息提供给技术支持。
                        <br>
                        <i class="fas fa-clock"></i> 
                        错误发生时间: ${new Date().toLocaleString()}
                    </small>
                </div>
            `;
            
            errorDetails.innerHTML = detailsHtml;
            
            // 显示模态框
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
        }

        // 复制错误信息到剪贴板
        function copyErrorToClipboard() {
            const errorDetails = document.getElementById('error-details');
            const textToCopy = errorDetails.innerText || errorDetails.textContent;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                addLog('错误信息已复制到剪贴板', 'success');
            }).catch(() => {
                addLog('复制失败，请手动复制', 'warning');
            });
        }

        // 文件大小格式化
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 重置上传
        function resetUpload() {
            currentFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
        }

        // 重置所有状态
        function resetAll() {
            // 重置所有状态
            currentFile = null;
            fileInput.value = '';
            processResults = [];
            
            // 显示上传区域，隐藏其他区域
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('file-info').style.display = 'none';
            uploadArea.style.display = 'block';
            
            // 清空日志
            document.getElementById('log-container').innerHTML = '<div class="text-muted">处理日志将在这里显示...</div>';
        }

        // 导出结果
        function downloadResults() {
            const csvContent = convertToCSV();
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            // 生成带时间戳和原始文件名的导出文件名
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const originalFileName = currentFile ? currentFile.name.replace(/\.[^\.]+$/, '') : 'unknown';
            link.download = `去重结果_${originalFileName}_${timestamp}.csv`;
            
            link.click();
        }

        function convertToCSV() {
            const headers = ['记录类型', '书名', '作者', '出版社', '相似度', '匹配类型', '原始记录索引', '重复组ID'];
            let csv = headers.join(',') + '\n';
            
            // 为每个重复组生成唯一ID
            const groupIdMap = new Map();
            let groupCounter = 1;
            
            processResults.forEach(result => {
                // 为重复组分配ID
                let groupId = '';
                if (result.type === 'duplicate' && result.duplicates) {
                    const groupKey = (result.original_index + 1) + '_' + result.duplicates.map(d => d.original_index + 1).join('_');
                    if (!groupIdMap.has(groupKey)) {
                        groupIdMap.set(groupKey, groupCounter++);
                    }
                    groupId = groupIdMap.get(groupKey);
                }
                
                // 主记录
                const mainRow = [
                    '主记录',
                    `"${result.title || ''}"`,
                    `"${result.author || ''}"`,
                    `"${result.publisher || ''}"`,
                    '', // 相似度（主记录为空）
                    '', // 匹配类型
                    result.original_index !== undefined ? result.original_index + 1 : '',
                    groupId || ''
                ];
                csv += mainRow.join(',') + '\n';
                
                // 重复记录详情
                if (result.type === 'duplicate' && result.duplicates) {
                    result.duplicates.forEach(duplicate => {
                        const dupRow = [
                            '重复项',
                            `"${duplicate.title || ''}"`,
                            `"${duplicate.author || ''}"`,
                            `"${duplicate.publisher || ''}"`,
                            duplicate.similarity ? (duplicate.similarity * 100).toFixed(1) + '%' : '',
                            duplicate.match_type || '',
                            duplicate.original_index !== undefined ? duplicate.original_index + 1 : '',
                            groupId || ''
                        ];
                        csv += dupRow.join(',') + '\n';
                    });
                }
            });
            
            // 添加唯一记录
            processResults.forEach(result => {
                if (result.type === 'unique') {
                    const uniqueRow = [
                        '唯一记录',
                        `"${result.title || ''}"`,
                        `"${result.author || ''}"`,
                        `"${result.publisher || ''}"`,
                        '',
                        '',
                        result.original_index !== undefined ? result.original_index + 1 : '',
                        ''
                    ];
                    csv += uniqueRow.join(',') + '\n';
                }
            });
            
            return csv;
        }
    </script>
</body>
</html>